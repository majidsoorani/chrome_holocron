<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Holocron Options</title>
    <link rel="stylesheet" href="options.css">
    <style>
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .button-bar button.pulse {
            animation: pulse-animation 2s infinite;
        }
        .button-bar button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Holocron Settings</h1>
            <p>Configure the SSH tunnel and proxy behavior.</p>
        </header>

        <div class="button-bar">
            <div class="action-buttons">
                <button id="save-button" class="primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Save Settings
                </button>
                <button id="test-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    Test Connection
                </button>
                <button id="discard-button" class="button-secondary" style="display: none;">Discard Changes</button>
                <div id="status-message">
                    <span id="status-icon"></span>
                    <span id="status-text"></span>
                </div>
            </div>
            <div class="connection-controls">
                <div id="connection-status-indicator" class="status-indicator"></div>
                <span id="connection-status-text">Loading...</span>
                <button id="disconnect-tunnel-button" class="button-warn" style="display: none;">Disconnect</button>
            </div>
        </div>

        <div class="tabs-container">
            <nav class="tabs-nav">
                <button class="tab-button active" data-tab="connections">Connections & Health</button>
                <button class="tab-button" data-tab="proxy">Proxy & Routing</button>
                <button class="tab-button" data-tab="settings">Settings & Logs</button>
            </nav>

            <div class="tabs-content">
                <!-- Connections & Health Panel -->
                <div class="tab-panel active" id="panel-connections">
                    <div class="main-layout-grid">
                        <div class="main-content">
                            <section class="card">
                                <h2>Core Configurations</h2>
                                <div id="core-configurations-list">
                                    <!-- Configurations will be dynamically inserted here -->
                                </div>
                                <div class="button-group" style="margin-top: 1em; display: flex; gap: 10px;">
                                    <button id="add-config-button" class="add-button" style="margin-top: 0;">+ Add Custom Configuration</button>
                                    <button id="add-predefined-config-button" class="add-button" style="margin-top: 0;">+ Add Predefined Profile</button>
                                </div>
                            </section>
                             <section class="card">
                                <details>
                                    <summary>
                                        <h3>Connection Health History</h3>
                                    </summary>
                                    <p class="chart-title"><strong>Web Latency (Full HTTP/S Request)</strong></p>
                                    <div class="chart-wrapper">
                                        <canvas id="web-latency-chart"></canvas>
                                    </div>
                                    <p class="chart-title"><strong>TCP Ping Latency (Raw Socket)</strong></p>
                                    <div class="chart-wrapper">
                                        <canvas id="tcp-ping-chart"></canvas>
                                    </div>
                                </details>
                            </section>
                        </div>
                        <div class="sidebar-content">
                            <section class="card">
                                <h2>Automatic Connection</h2>
                                <div class="form-group">
                                    <p><strong>Connect only on these Wi-Fi SSIDs</strong></p>
                                    <div id="wifi-networks-list">
                                        <!-- Wi-Fi SSIDs will be inserted here -->
                                    </div>
                                    <button id="add-wifi-button" class="add-button">+ Add Wi-Fi Network</button>
                                </div>
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="auto-reconnect-enabled" name="auto-reconnect-enabled">
                                    <label for="auto-reconnect-enabled">Enable Auto-Reconnect</label>
                                    <small>Automatically try to restart the tunnel if it disconnects.</small>
                                </div>
                                <div class="form-group" id="manual-reconnect-container" style="display: none;">
                                    <label for="reconnect-now-button">Manual Reconnect</label>
                                    <button id="reconnect-now-button" class="button-success">Reconnect Now</button>
                                    <small>If the tunnel is disconnected, you can force a reconnection attempt.</small>
                                </div>
                            </section>
                            <section class="card">
                                <h2>Connection Health Checks</h2>
                                <div class="form-group">
                                    <label for="ping-host">Ping Host</label>
                                    <input type="text" id="ping-host" name="ping-host">
                                    <small>A reliable host for TCP ping checks (e.g., youtube.com).</small>
                                </div>
                                <div class="form-group">
                                    <label for="web-check-url">Web Check URL</label>
                                    <input type="url" id="web-check-url" name="web-check-url">
                                    <small>A URL for full HTTP/S connectivity checks.</small>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Proxy & Routing Panel -->
                <div class="tab-panel" id="panel-proxy">
                    <div class="settings-grid">
                        <section class="card full-width">
                            <h2>Proxy Bypass Rules</h2>
                            <p>Define global rules for when to bypass the active proxy tunnel. The generated PAC script on the right will update as you make changes.</p>
                            <div class="proxy-actions-bar form-group">
                                <button id="apply-proxy-button" class="button-info" style="display: none;">Apply Proxy</button>
                                <button id="revert-proxy-button" class="button-warn" style="display: none;">Revert Proxy</button>
                                <small>Apply the PAC script to your browser's settings to route traffic.</small>
                            </div>
                            <div class="settings-grid two-column">
                                <div class="settings-column">
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" id="global-geoip-bypass">
                                        <label for="global-geoip-bypass">Bypass proxy for Iranian IPs (GeoIP)</label>
                                    </div>
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" id="global-geosite-bypass">
                                        <label for="global-geosite-bypass">Bypass proxy for Iranian sites (GeoSite)</label>
                                    </div>
                                    <h3 class="sub-heading" style="margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--border-color-light);">Incognito Mode Proxy</h3>
                                    <div class="form-group">
                                        <label for="incognito-proxy-select">Incognito-Specific Proxy</label>
                                        <select id="incognito-proxy-select" name="incognito-proxy-select">
                                            <option value="">-- Use Regular Proxy Settings --</option>
                                            <!-- Options will be populated by JS -->
                                        </select>
                                        <small>Select a configuration to use exclusively for Incognito windows. This will not affect your regular browsing session.</small>
                                    </div>

                                    <h3 class="sub-heading" style="margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--border-color-light);">Custom Routing Rules</h3>
                                    <div id="proxy-bypass-rules-list">
                                        <!-- Custom rules will be inserted here -->
                                    </div>
                                    <div class="rule-actions" style="display: flex; gap: 10px; align-items: center; margin-top: 1em;">
                                        <button id="add-proxy-rule-button" class="add-button" style="margin-top: 0;">+ Add Rule</button>
                                        <button id="ai-suggest-rule-button" class="button-info" style="margin-top: 0;">Get AI Suggestion</button>
                                    </div>
                                    <small>Define domains and choose whether to send them DIRECT (bypass) or through a specific active tunnel.</small>
                                </div>
                                <div class="settings-column">
                                    <h3 class="sub-heading">Generated PAC Script Preview</h3>
                                    <pre id="pac-script-preview-container"><code>// PAC script will be generated here...</code></pre>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Settings & Logs Panel -->
                <div class="tab-panel" id="panel-settings">
                    <div class="settings-grid">
                        <section class="card">
                            <h2>AI Assistant (Powered by OpenRouter)</h2>
                            <div class="form-group">
                                <label for="openrouter-api-key">OpenRouter API Key</label>
                                <input type="password" id="openrouter-api-key" name="openrouter-api-key" placeholder="sk-or-...">
                                <small>Your API key from <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer">OpenRouter.ai</a>. Required for AI-powered suggestions.</small>
                            </div>
                            <div class="form-group">
                                <label for="openrouter-model">AI Model</label>
                                <input type="text" id="openrouter-model" name="openrouter-model">
                                <small>The model to use for suggestions (e.g., z-ai/glm-4.5-air:free, google/gemini-flash-1.5).</small>
                            </div>
                            <div class="form-group">
                                <label for="openrouter-system-message">AI System Message</label>
                                <textarea id="openrouter-system-message" name="openrouter-system-message" rows="6"></textarea>
                                <small>The system prompt used to instruct the AI. Modify with caution.</small>
                            </div>
                            <div id="ai-live-log-container" class="log-viewer-container" style="display: none; margin-top: 1em; height: 150px;">
                                <pre id="ai-live-log-content"></pre>
                            </div>
                        </section>
                        <section class="card">
                            <h2>Privacy Controls</h2>
                             <div class="form-group checkbox-group">
                                <input type="checkbox" id="webrtc-policy-toggle" name="webrtc-policy-toggle">
                                <label for="webrtc-policy-toggle">Prevent WebRTC IP Leak</label>
                                <small>Sets WebRTC to only use proxied network connections, preventing your real IP from being exposed. Recommended to keep enabled.</small>
                            </div>
                        </section>
                        <section class="card">
                            <h2>Native Host Live Log</h2>
                            <p><small>Shows a live feed of the most recent entries from the native host log file.</small></p>
                            <div class="log-viewer-container">
                                <pre id="log-viewer-content">Waiting for log entries...</pre>
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                                <button id="clear-log-button" class="button-warn">Clear Log</button>
                                <small>This is useful for debugging connection issues.</small>
                            </div>
                        </section>
                        <section class="card">
                            <h2>Geo-Database Status</h2>
                            <div class="database-status" style="border-top: none; margin-top: 0; padding-top: 0;">
                                <div id="geoip-status">GeoIP: Loading...</div>
                                <div id="geosite-status">GeoSite: Loading...</div>
                                <button id="update-db-button">Update Databases Now</button>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

    <!-- Templates for dynamic elements -->
    <template id="port-forward-rule-template">
        <div class="rule-item">
            <select class="rule-type" name="rule-type" aria-label="Forwarding Type">
                <option value="L">Local (-L)</option>
                <option value="R">Remote (-R)</option>
                <option value="D">Dynamic (-D)</option>
            </select>
            <input type="number" class="rule-local-port" name="rule-local-port" placeholder="Local Port" min="1" max="65535" aria-label="Local Port">
            <span class="rule-colon">:</span>
            <input type="text" class="rule-remote-host" name="rule-remote-host" placeholder="Remote Host" aria-label="Remote Host">
            <span class="rule-colon">:</span>
            <input type="number" class="rule-remote-port" name="rule-remote-port" placeholder="Remote Port" min="1" max="65535" aria-label="Remote Port">
            <button class="remove-rule-button" title="Remove rule">&times;</button>
        </div>
    </template>

    <template id="wifi-network-template">
        <div class="rule-item">
            <input type="text" class="wifi-ssid-input" name="wifi-ssid" placeholder="Wi-Fi SSID" aria-label="Wi-Fi SSID">
            <button class="remove-rule-button" title="Remove SSID">&times;</button>
        </div>
    </template>

    <template id="proxy-bypass-rule-template">
        <div class="rule-item proxy-rule-item">
            <input type="text" class="bypass-domain-input" placeholder="e.g., *.example.com" aria-label="Bypass Domain">
            <span style="margin: 0 8px;">-></span>
            <select class="bypass-target-select" aria-label="Bypass Target">
                <option value="DIRECT">DIRECT (Bypass Proxy)</option>
                <!-- Core configurations will be dynamically added here -->
            </select>
            <button class="remove-rule-button" title="Remove rule">&times;</button>
        </div>
    </template>

    <template id="core-configuration-template">
        <div class="config-item rule-item" data-id="">
            <div class="config-header">
                <span class="config-icon" style="margin-right: 8px; display: inline-flex; align-items: center; color: var(--text-color-secondary, #555);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
                </span>
                <label class="toggle-switch">
                    <input type="checkbox" class="config-enabled-checkbox">
                    <span class="slider"></span>
                </label>
                <div class="config-summary" style="flex-grow: 1;">
                    <strong class="config-name">New Configuration</strong>
                    <span class="status-badge active">Active</span>
                    <small class="config-user-host" style="color: var(--text-color-secondary, #666); font-size: 0.9em;"></small>
                </div>
                <div class="config-controls">
                    <button class="connect-config-button icon-button" title="Connect using this configuration">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button class="disconnect-config-button icon-button button-warn" title="Disconnect this tunnel" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                    </button>
                    <button class="duplicate-config-button icon-button" title="Duplicate this configuration">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                    <button class="edit-config-button icon-button" title="Edit configuration">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    <button class="remove-rule-button delete-config-button icon-button" title="Delete configuration">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
            </div>
            <div class="config-details" style="display: none;">
                <div class="form-group">
                    <label>Configuration Name</label>
                    <input type="text" class="config-input-name" placeholder="e.g., Work Bastion, University VPN">
                </div>
                <div class="form-group">
                    <label for="config-type-select">Connection Type</label>
                    <select class="config-type-select">
                        <option value="ssh">SSH Tunnel</option>
                        <option value="openvpn">OpenVPN</option>
                        <option value="v2ray">V2Ray</option>
                        <option value="external">External Proxy</option>
                    </select>
                </div>

                <!-- External Proxy Specific Fields -->
                <div class="external-settings" style="display: none;">
                    <div class="form-group">
                        <label>Proxy Protocol</label>
                        <select class="config-input-external-protocol">
                            <option value="SOCKS5">SOCKS5</option>
                            <option value="SOCKS4">SOCKS4</option>
                            <option value="HTTP">HTTP</option>
                            <option value="HTTPS">HTTPS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Proxy Host</label>
                        <input type="text" class="config-input-external-host" placeholder="127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label>Proxy Port</label>
                        <input type="number" class="config-input-external-port" placeholder="9050" min="1" max="65535">
                    </div>
                </div>

                <!-- SSH Specific Fields -->
                <div class="ssh-settings">
                    <div class="form-group">
                        <label>SSH User</label>
                        <input type="text" class="config-input-ssh-user" placeholder="user">
                    </div>
                    <div class="form-group">
                        <label>SSH Host</label>
                        <input type="text" class="config-input-ssh-host" placeholder="bastion.example.com">
                    </div>
                    <div class="form-group">
                        <label>Remote Command on Connect</label>
                        <textarea class="config-input-ssh-remote-command" rows="3" placeholder="e.g., export MY_VAR=123;"></textarea>
                    </div>
                    <h3 class="sub-heading" style="margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--border-color-light);">Port Forwarding Rules</h3>
                    <div class="port-forwarding-rules-list">
                        <!-- Rules will be dynamically inserted here -->
                    </div>
                    <button type="button" class="add-port-forward-rule-button add-button">+ Add Rule</button>
                </div>

                <!-- OpenVPN Specific Fields -->
                <div class="openvpn-settings" style="display: none;">
                    <div class="form-group">
                        <label for="ovpn-profile-name">Profile Name</label>
                        <input type="text" class="ovpn-profile-name" name="ovpn-profile-name" placeholder="e.g., 'University VPN' or 'Work Gateway'">
                        <small>A unique name to identify this OpenVPN profile.</small>
                    </div>
                    <div class="form-group">
                        <label for="ovpn-file-upload">Upload .ovpn File</label>
                        <input type="file" class="ovpn-file-upload" name="ovpn-file-upload" accept=".ovpn">
                        <small class="ovpn-file-status">No file selected.</small>
                        <!-- Hidden input to store the file content -->
                        <textarea class="ovpn-file-content" name="ovpn-file-content" style="display:none;"></textarea>
                    </div>
                    <div class="form-group ovpn-auth-container" style="display: none; flex-direction: column; gap: 5px;">
                        <label>Profile Authentication</label>
                        <input type="text" class="ovpn-auth-user" placeholder="Username" autocomplete="username">
                        <input type="password" class="ovpn-auth-pass" placeholder="Password" autocomplete="current-password">
                        <small>These credentials are required by this .ovpn profile and will be passed securely.</small>
                    </div>
                </div>

                <!-- V2Ray Specific Fields -->
                <div class="v2ray-settings" style="display: none;">
                    <div class="form-group">
                        <label>V2Ray URL</label>
                        <textarea class="config-input-v2ray-url" rows="4" placeholder="Enter your vless://... URL here."></textarea>
                        <small>Paste the full V2Ray configuration URL.</small>
                    </div>
                    <div class="v2ray-detected-params" style="display: none;">
                        <strong>Detected Parameters:</strong>
                        <ul class="v2ray-params-list"></ul>
                    </div>
                </div>
                <!-- Live Log Viewer for this specific configuration -->
                <div class="config-live-log-container log-viewer-container" style="display: none; margin-top: 1em; height: 200px;">
                    <pre class="config-live-log-content">Waiting for connection logs...</pre>
                </div>
            </div>
        </div>
    </template>

    <script src="vendor/chart.js"></script>
    <script type="module" src="options.js"></script>

    <!-- Modal for Predefined Profiles -->
    <div id="predefined-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 style="margin-top:0;">Add a Predefined Profile</h2>
            <p>Select a service to create a pre-configured "External Proxy" profile for it. You must ensure the service (e.g., the Tor client) is running on your computer for the proxy to work.</p>
            <div class="predefined-choices">
                <button data-profile="tor">Tor</button>
                <button data-profile="privoxy">Privoxy</button>
                <button data-profile="psiphon">Psiphon (SOCKS)</button>
            </div>
            <button id="modal-close-button" class="button-secondary" style="margin-top: 1.5em;">Cancel</button>
        </div>
    </div>

    <footer style="margin-top: 2em;">
        <section class="card full-width">
            <h2>Geo-Database Status</h2>
            <div class="database-status" style="border-top: none; margin-top: 0; padding-top: 0;">
                <div id="geoip-status">GeoIP: Loading...</div>
                <div id="geosite-status">GeoSite: Loading...</div>
                <button id="update-db-button">Update Databases Now</button>
            </div>
        </section>
    </footer>
</body>
</html>