<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Holocron Options</title>
    <link rel="stylesheet" href="options.css">
    <style>
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .button-bar button.pulse {
            animation: pulse-animation 2s infinite;
        }
        .button-bar button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .warning-message {
            background-color: var(--warning-bg-color, #fff3cd);
            color: var(--warning-text-color, #856404);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--warning-border-color, #ffeeba);
            font-size: 0.9em;
        }
        .warning-message a {
            color: var(--warning-text-color, #856404);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Holocron Settings</h1>
            <p>Configure the SSH tunnel and proxy behavior.</p>
        </header>

        <div class="button-bar">
            <div id="status-message">
                <!-- This is used for "Saving...", "Settings saved!", etc. -->
            </div>
            <div class="connection-controls">
                <div id="connection-status-indicator" class="status-indicator"></div>
                <span id="connection-status-text">Loading...</span>
                <button id="disconnect-tunnel-button" class="button-warn" style="display: none;">Disconnect</button>
            </div>
        </div>

        <div class="tabs-container">
            <nav class="tabs-nav">
                <button class="tab-button active" data-tab="connections">Connections & Health</button>
                <button class="tab-button" data-tab="proxy">Proxy & Routing</button>
                <button class="tab-button" data-tab="settings">Settings & Logs</button>
            </nav>

            <div class="tabs-content">
                <!-- Connections & Health Panel -->
                <div class="tab-panel active" id="panel-connections">
                    <div class="main-layout-grid">
                        <div class="main-content">
                            <section class="card">
                                <h2>Core Configurations</h2>
                                <div id="core-configurations-list">
                                    <!-- Configurations will be dynamically inserted here -->
                                </div>
                                <div class="button-group" style="margin-top: 1em; display: flex; gap: 10px;">
                                    <button id="add-config-button" class="add-button" style="margin-top: 0;">+ Add Custom Configuration</button>
                                    <button id="add-predefined-config-button" class="add-button" style="margin-top: 0;">+ Add Predefined Profile</button>
                                </div>
                            </section>
                             <section class="card">
                                <details>
                                    <summary>
                                        <h3>Connection Health History</h3>
                                    </summary>
                                    <p class="chart-title"><strong>Web Latency (Full HTTP/S Request)</strong></p>
                                    <div class="chart-wrapper">
                                        <canvas id="web-latency-chart"></canvas>
                                    </div>
                                    <p class="chart-title"><strong>TCP Ping Latency (Raw Socket)</strong></p>
                                    <div class="chart-wrapper">
                                        <canvas id="tcp-ping-chart"></canvas>
                                    </div>
                                </details>
                            </section>
                        </div>
                        <div class="sidebar-content">
                            <section class="card">
                                <h2>Automatic Connection</h2>
                                <div class="form-group">
                                    <p><strong>Connect only on these Wi-Fi SSIDs</strong></p>
                                    <div id="wifi-networks-list">
                                        <!-- Wi-Fi SSIDs will be inserted here -->
                                    </div>
                                    <button id="add-wifi-button" class="add-button">+ Add Wi-Fi Network</button>
                                </div>
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="auto-reconnect-enabled" name="auto-reconnect-enabled">
                                    <label for="auto-reconnect-enabled">Enable Auto-Reconnect</label>
                                    <small>Automatically try to restart the tunnel if it disconnects.</small>
                                </div>
                                <div class="form-group" id="manual-reconnect-container" style="display: none;">
                                    <label for="reconnect-now-button">Manual Reconnect</label>
                                    <button id="reconnect-now-button" class="button-success">Reconnect Now</button>
                                    <small>If the tunnel is disconnected, you can force a reconnection attempt.</small>
                                </div>
                            </section>
                            <section class="card">
                                <h2>Connection Health Checks</h2>
                                <div class="form-group">
                                    <label for="ping-host">Ping Host</label>
                                    <input type="text" id="ping-host" name="ping-host">
                                    <small>A reliable host for TCP ping checks (e.g., youtube.com).</small>
                                </div>
                                <div class="form-group">
                                    <label for="web-check-url">Web Check URL</label>
                                    <input type="url" id="web-check-url" name="web-check-url">
                                    <small>A URL for full HTTP/S connectivity checks.</small>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Proxy & Routing Panel -->
                <div class="tab-panel" id="panel-proxy">
                    <div class="settings-grid">
                        <section class="card full-width">
                            <h2>Proxy Bypass Rules</h2>
                            <p>Define global rules for when to bypass the active proxy tunnel. The generated PAC script on the right will update as you make changes.</p>
                            <div class="proxy-actions-bar form-group">
                                <button id="apply-proxy-button" class="button-info" style="display: none;">Apply Proxy</button>
                                <button id="revert-proxy-button" class="button-warn" style="display: none;">Revert Proxy</button>
                                <small>Apply the PAC script to your browser's settings to route traffic.</small>
                            </div>
                            <div class="settings-grid two-column">
                                <div class="settings-column">
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" id="global-geoip-bypass">
                                        <label for="global-geoip-bypass">Bypass proxy for Iranian IPs (GeoIP)</label>
                                    </div>
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" id="global-geosite-bypass">
                                        <label for="global-geosite-bypass">Bypass proxy for Iranian sites (GeoSite)</label>
                                    </div>
                                    <h3 class="sub-heading" style="margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--border-color-light);">Incognito Mode Proxy</h3>
                                    <div class="form-group">
                                        <label for="incognito-proxy-select">Incognito-Specific Proxy</label>
                                        <select id="incognito-proxy-select" name="incognito-proxy-select">
                                            <option value="">-- Use Regular Proxy Settings --</option>
                                            <!-- Options will be populated by JS -->
                                        </select>
                                        <small>Select a configuration to use exclusively for Incognito windows. This will not affect your regular browsing session.</small>
                                        <div id="incognito-permission-warning" class="warning-message" style="display: none; margin-top: 8px;">
                                            To use this feature, you must <a href="chrome://extensions" target="_blank" rel="noopener noreferrer">enable 'Allow in Incognito'</a> for the Holocron extension.
                                        </div>
                                    </div>

                                    <h3 class="sub-heading" style="margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--border-color-light);">Custom Routing Rules</h3>
                                    <div class="form-group">
                                        <input type="search" id="search-proxy-rules" placeholder="Filter rules by domain...">
                                    </div>
                                    <div id="proxy-bypass-rules-list">
                                        <!-- Custom rules will be inserted here -->
                                    </div>
                                    <div class="rule-actions" style="display: flex; gap: 10px; align-items: center; margin-top: 1em;">
                                        <button id="add-proxy-rule-button" class="add-button" style="margin-top: 0;">+ Add Rule</button>
                                        <button id="ai-suggest-rule-button" class="button-info" style="margin-top: 0;">Get AI Suggestion</button>
                                    </div>
                                    <small>Define domains and choose whether to send them DIRECT (bypass) or through a specific active tunnel. Use the prompt for the AI for suggestions like "Bypass all social media sites".</small>
                                </div>
                                <div class="settings-column">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h3 class="sub-heading">Generated PAC Script Preview</h3>
                                        <button id="copy-pac-button" class="button-secondary" style="padding: 4px 8px; font-size: 0.8em;">Copy</button>
                                    </div>
                                    <pre id="pac-script-preview-container"><code>// PAC script will be generated here...</code></pre>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Settings & Logs Panel -->
                <div class="tab-panel" id="panel-settings">
                    <div class="settings-grid">
                        <section class="card">
                            <h2>AI Assistant (Powered by GitHub)</h2>
                            <div class="form-group">
                                <label for="ai-api-key">GitHub Models API Key</label>
                                <input type="password" id="ai-api-key" name="ai-api-key" placeholder="ghm_...">
                                <small>Your API key from <a href="https://github.com/settings/copilot" target="_blank" rel="noopener noreferrer">GitHub Models</a>. Required for AI-powered suggestions.</small>
                            </div>
                            <div class="form-group">
                                <label for="ai-model">AI Model</label>
                                <input type="text" id="ai-model" name="ai-model">
                                <small>The model to use for suggestions (e.g., openai/gpt-4.1-nano).</small>
                            </div>
                            <details>
                                <summary>Advanced AI Settings</summary>
                                <div class="form-group" style="margin-top: 1em;">
                                    <label for="ai-system-message">AI System Message</label>
                                    <textarea id="ai-system-message" name="ai-system-message" rows="6"></textarea>
                                    <small>The system prompt used to instruct the AI. Modify with caution.</small>
                                </div>
                            </details>
                            <div id="ai-live-log-container" class="log-viewer-container" style="display: none; margin-top: 1em; height: 150px;">
                                <pre id="ai-live-log-content"></pre>
                            </div>
                        </section>
                        <section class="card">
                            <h2>Privacy Controls</h2>
                             <div class="form-group checkbox-group">
                                <input type="checkbox" id="webrtc-policy-toggle" name="webrtc-policy-toggle">
                                <label for="webrtc-policy-toggle">Prevent WebRTC IP Leak</label>
                                <small>Sets WebRTC to only use proxied network connections, preventing your real IP from being exposed. Recommended to keep enabled.</small>
                            </div>
                        </section>
                        <section class="card">
                            <h2>Native Host Live Log</h2>
                            <p><small>Shows a live feed of the most recent entries from the native host log file.</small></p>
                            <div class="log-viewer-container">
                                <pre id="log-viewer-content">Waiting for log entries...</pre>
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                                <button id="toggle-log-polling-button" class="button-secondary">Pause Log</button>
                                <button id="copy-log-button" class="button-secondary">Copy Log</button>
                                <button id="clear-log-button" class="button-warn">Clear Log</button>
                            </div>
                        </section>
                        <section class="card">
                            <h2>Geo-Database Status</h2>
                            <div class="database-status" style="border-top: none; margin-top: 0; padding-top: 0;">
                                <div id="geoip-status">GeoIP: Loading...</div>
                                <div id="geosite-status">GeoSite: Loading...</div>
                                <button id="update-db-button">Update Databases Now</button>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

    <!-- Templates for dynamic elements -->
    <template id="port-forward-rule-template">
        <div class="rule-item">
            <select class="rule-type" name="rule-type" aria-label="Forwarding Type">
                <option value="L">Local (-L)</option>
                <option value="R">Remote (-R)</option>
                <option value="D">Dynamic (-D)</option>
            </select>
            <input type="number" class="rule-local-port" name="rule-local-port" placeholder="Local Port" min="1" max="65535" aria-label="Local Port">
            <span class="rule-colon">:</span>
            <input type="text" class="rule-remote-host" name="rule-remote-host" placeholder="Remote Host" aria-label="Remote Host">
            <span class="rule-colon">:</span>
            <input type="number" class="rule-remote-port" name="rule-remote-port" placeholder="Remote Port" min="1" max="65535" aria-label="Remote Port">
            <button class="remove-rule-button" title="Remove rule">&times;</button>
        </div>
    </template>

    <template id="wifi-network-template">
        <div class="rule-item">
            <input type="text" class="wifi-ssid-input" name="wifi-ssid" placeholder="Wi-Fi SSID" aria-label="Wi-Fi SSID">
            <button class="remove-rule-button" title="Remove SSID">&times;</button>
        </div>
    </template>

    <template id="proxy-bypass-rule-template">
        <div class="rule-item proxy-rule-item">
            <label class="toggle-switch" title="Enable/Disable Rule">
                <input type="checkbox" class="rule-enabled-checkbox" checked>
                <span class="slider"></span>
            </label>
            <input type="text" class="bypass-domain-input" placeholder="e.g., *.example.com" aria-label="Bypass Domain">
            <span style="margin: 0 8px;">-></span>
            <select class="bypass-target-select" aria-label="Bypass Target">
                <option value="DIRECT">DIRECT (Bypass Proxy)</option>
                <!-- Core configurations will be dynamically added here -->
            </select>
            <button class="remove-rule-button" title="Remove rule">&times;</button>
        </div>
    </template>

    <template id="core-configuration-template">
        <div class="config-card" data-id="">
            <div class="config-card-header">
                <div class="config-status-area">
                    <span class="status-badge" data-status="disconnected">[●]</span>
                    <strong class="config-name">New Configuration</strong>
                </div>
                <div class="config-main-controls">
                    <button class="connect-config-button button-success">Connect</button>
                    <button class="disconnect-config-button button-warn" style="display: none;">Disconnect</button>
                    <button class="edit-config-button button-secondary">Edit</button>
                </div>
            </div>
            <div class="config-card-body">
                <div class="config-health-metrics">
                     <div class="metric-item">
                        <span class="label">Web Latency</span>
                        <span class="value web-latency-value">--</span>
                    </div>
                    <div class="metric-item">
                        <span class="label">TCP Ping</span>
                        <span class="value tcp-ping-value">--</span>
                    </div>
                    <div class="metric-item">
                        <span class="label">Status</span>
                        <span class="value test-status-value">Not Tested</span>
                    </div>
                </div>
                 <div class="config-health-actions">
                    <button type="button" class="test-config-button button-secondary">Test</button>
                    <div class="test-status-message"></div>
                 </div>
            </div>
            <div class="config-details" style="display: none;">
                <div class="form-group-grid">
                    <div class="form-group">
                        <label>Configuration Name</label>
                        <input type="text" class="config-input-name" placeholder="e.g., Work Bastion, University VPN">
                    </div>
                    <div class="form-group">
                        <label>Connection Type</label>
                        <select class="config-type-select">
                            <option value="ssh">SSH Tunnel</option>
                            <option value="openvpn">OpenVPN</option>
                            <option value="v2ray">V2Ray</option>
                            <option value="external">External Proxy</option>
                        </select>
                    </div>
                </div>

                <!-- External Proxy Specific Fields -->
                <div class="external-settings" style="display: none;">
                    <div class="form-group-grid three-column">
                        <div class="form-group">
                            <label>Protocol</label>
                            <select class="config-input-external-protocol">
                                <option value="SOCKS5">SOCKS5</option>
                                <option value="SOCKS4">SOCKS4</option>
                                <option value="HTTP">HTTP</option>
                                <option value="HTTPS">HTTPS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Proxy Host</label>
                            <input type="text" class="config-input-external-host" placeholder="127.0.0.1">
                        </div>
                        <div class="form-group">
                            <label>Proxy Port</label>
                            <input type="number" class="config-input-external-port" placeholder="9050" min="1" max="65535">
                        </div>
                    </div>
                    <small>Use this for connecting to an existing proxy server running on your machine or network (e.g., Tor, Privoxy).</small>
                </div>

                <!-- SSH Specific Fields -->
                <div class="ssh-settings">
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label>SSH User</label>
                            <input type="text" class="config-input-ssh-user" placeholder="e.g., root">
                        </div>
                        <div class="form-group">
                            <label>SSH Host</label>
                            <input type="text" class="config-input-ssh-host" placeholder="e.g., bastion.example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Remote Command (Optional)</label>
                        <input type="text" class="config-input-ssh-remote-command" placeholder="e.g., /usr/local/bin/my_script.sh">
                        <small>A command to run on the remote host after connecting.</small>
                    </div>
                    <div class="form-group">
                        <label>Port Forwarding Rules</label>
                        <div class="port-forwarding-rules-list">
                            <!-- Rules will be dynamically inserted here -->
                        </div>
                        <button class="add-port-forward-rule-button add-button">+ Add Port Forward Rule</button>
                    </div>
                </div>

                <!-- OpenVPN Specific Fields -->
                <div class="openvpn-settings" style="display: none;">
                    <div class="form-group">
                        <label>Profile Name</label>
                        <input type="text" class="ovpn-profile-name" placeholder="e.g., My VPN">
                        <small>A friendly name for this OpenVPN connection.</small>
                    </div>
                    <div class="form-group">
                        <label>OpenVPN Configuration File (.ovpn)</label>
                        <input type="file" class="ovpn-file-upload" accept=".ovpn,.conf">
                        <small class="ovpn-file-status">No file selected.</small>
                        <textarea class="ovpn-file-content" style="display:none;"></textarea>
                    </div>
                    <div class="ovpn-auth-container" style="display: none;">
                        <p><small>This profile requires a username and password.</small></p>
                        <div class="form-group-grid">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" class="ovpn-auth-user" autocomplete="username">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" class="ovpn-auth-pass" autocomplete="current-password">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- V2Ray Specific Fields -->
                <div class="v2ray-settings" style="display: none;">
                    <div class="form-group">
                        <label>V2Ray URL (VLESS)</label>
                        <input type="text" class="config-input-v2ray-url" placeholder="vless://...">
                        <small>Paste your full VLESS configuration URL here.</small>
                    </div>
                    <div class="v2ray-detected-params" style="display: none;">
                        <strong>Detected Parameters:</strong>
                        <ul class="v2ray-params-list"></ul>
                    </div>
                </div>

                <div class="config-details-actions">
                     <label class="toggle-switch">
                        <input type="checkbox" class="config-enabled-checkbox">
                        <span class="slider"></span>
                        <span>Enabled (Auto-Connect default)</span>
                    </label>
                    <button class="duplicate-config-button button-secondary">Duplicate</button>
                    <button class="delete-config-button button-danger">Delete</button>
                </div>

                <!-- Live Log Viewer for this specific configuration -->
                <div class="config-live-log-container log-viewer-container" style="display: none;">
                    <pre class="config-live-log-content">Waiting for connection logs...</pre>
                </div>
            </div>
        </div>
    </template>

    <script src="vendor/chart.js"></script>
    <script type="module" src="options.js"></script>

    <!-- Modal for Predefined Profiles -->
    <div id="predefined-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 style="margin-top:0;">Add a Predefined Profile</h2>
            <p>Select a service to create a pre-configured "External Proxy" profile for it. You must ensure the service (e.g., the Tor client) is running on your computer for the proxy to work.</p>
            <div class="predefined-choices">
                <button data-profile="tor">Tor</button>
                <button data-profile="privoxy">Privoxy</button>
                <button data-profile="psiphon">Psiphon (SOCKS)</button>
            </div>
            <button id="modal-close-button" class="button-secondary" style="margin-top: 1.5em;">Cancel</button>
        </div>
    </div>

</body>
</html>